<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Finance Manager</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f4f8;
      max-width: 500px;
      margin: 40px auto;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #007bff;
      text-align: center;
    }
    label, input, select, button {
      display: block;
      width: 100%;
      margin-bottom: 12px;
      padding: 8px;
      font-size: 16px;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      background: #eef2f7;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .actions button {
      margin-left: 6px;
      padding: 6px 10px;
      font-size: 14px;
      cursor: pointer;
      border: none;
      border-radius: 3px;
    }
    .updateBtn {
      background-color: #ffc107;
      color: white;
    }
    .deleteBtn {
      background-color: #dc3545;
      color: white;
    }
    #logoutBtn {
      background-color: #007bff;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 20px;
    }
    #totalBalance {
      background: #e8f5e9;
      color: #2e7d32;
      border-radius: 6px;
      padding: 10px;
      font-weight: bold;
      font-size: 18px;
      text-align: center;
      margin-bottom: 20px;
      border: 1px solid #c8e6c9;
    }
  </style>
</head>
<body>
  <h1>Your Finance Manager</h1>

  <button id="logoutBtn">Logout</button>

  <!-- ✅ Total Balance Section -->
  <div id="totalBalance">Total Balance: ₹0</div>

  <form id="transactionForm">
    <select id="type" required>
      <option value="">Select Type</option>
      <option value="income">Income</option>
      <option value="expense">Expense</option>
    </select>
    <input id="amount" type="number" placeholder="Amount" min="1" required />
    <input id="category" type="text" placeholder="Category" required />
    <button type="submit">Add Transaction</button>
  </form>

  <ul id="transactionsList"></ul>

  <script>
    let userEmail = localStorage.getItem('userEmail');
    if (!userEmail) {
      alert('Please login first');
      window.location.href = 'index.html';
    }

    const form = document.getElementById('transactionForm');
    const typeInput = document.getElementById('type');
    const amountInput = document.getElementById('amount');
    const categoryInput = document.getElementById('category');
    const transactionsList = document.getElementById('transactionsList');
    const logoutBtn = document.getElementById('logoutBtn');
    const totalBalanceDiv = document.getElementById('totalBalance');

    let editingTxId = null;

    logoutBtn.onclick = () => {
      localStorage.removeItem('userEmail');
      window.location.href = 'index.html';
    };

    form.addEventListener('submit', async e => {
      e.preventDefault();
      const type = typeInput.value;
      const amount = +amountInput.value;
      const category = categoryInput.value.trim();

      if (!type || !amount || !category) {
        alert('Please fill all fields');
        return;
      }

      try {
        if (editingTxId) {
          // Update existing transaction
          await fetch(`http://localhost:5000/api/transactions/${editingTxId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userEmail, type, amount, category, date: new Date() }),
          });
          alert('Transaction updated');
          editingTxId = null;
          form.querySelector('button').textContent = 'Add Transaction';
        } else {
          // Add new transaction
          await fetch('http://localhost:5000/api/transactions', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userEmail, type, amount, category, date: new Date() }),
          });
          alert('Transaction added');
        }
        form.reset();
        loadTransactions();
      } catch (error) {
        alert('Error connecting to server');
      }
    });

    async function loadTransactions() {
      try {
        const res = await fetch(`http://localhost:5000/api/transactions/${userEmail}`);
        const transactions = await res.json();

        transactionsList.innerHTML = '';
        let total = 0;

        transactions.forEach(tx => {
          const li = document.createElement('li');
          li.textContent = `${tx.type.toUpperCase()} - ₹${tx.amount} - ${tx.category}`;

          // Calculate total
          if (tx.type === 'income') total += tx.amount;
          else if (tx.type === 'expense') total -= tx.amount;

          const actions = document.createElement('div');
          actions.classList.add('actions');

          const updateBtn = document.createElement('button');
          updateBtn.textContent = 'Update';
          updateBtn.classList.add('updateBtn');
          updateBtn.onclick = () => {
            editingTxId = tx._id;
            typeInput.value = tx.type;
            amountInput.value = tx.amount;
            categoryInput.value = tx.category;
            form.querySelector('button').textContent = 'Update Transaction';
          };

          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'Delete';
          deleteBtn.classList.add('deleteBtn');
          deleteBtn.onclick = async () => {
            if (confirm('Are you sure you want to delete this transaction?')) {
              await fetch(`http://localhost:5000/api/transactions/${tx._id}`, { method: 'DELETE' });
              alert('Transaction deleted');
              loadTransactions();
            }
          };

          actions.appendChild(updateBtn);
          actions.appendChild(deleteBtn);
          li.appendChild(actions);
          transactionsList.appendChild(li);
        });

        // ✅ Update total balance
        totalBalanceDiv.textContent = `Total Balance: ₹${total}`;
      } catch (error) {
        alert('Error loading transactions');
      }
    }

    loadTransactions();
  </script>
</body>
</html>
